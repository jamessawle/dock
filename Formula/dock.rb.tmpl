class Dock < Formula
  include Language::Python::Virtualenv

  desc "macOS Dock Manager (YAML-driven, dry-run friendly)"
  homepage "https://github.com/jamessawle/dock"
  PLACEHOLDER_URL_LINE
  PLACEHOLDER_SHA256_LINE
  license "MIT"
  head "https://github.com/jamessawle/dock.git", branch: "main"

  depends_on "dockutil"
  depends_on "libyaml"
  depends_on :macos
  depends_on "python@3.14"

  PLACEHOLDER_DEPENDENCIES_UPDATE_BEFORE_PUBLISHING

  def install
    virtualenv_install_with_resources

    # Generate shell completions using Click
    # Click requires environment variables to generate completions
    # We need to create wrapper scripts that set the env var
    (buildpath/"generate-bash-completion.sh").write <<~EOS
      #!/bin/bash
      _DOCK_COMPLETE=bash_source #{bin}/dock
    EOS

    (buildpath/"generate-zsh-completion.sh").write <<~EOS
      #!/bin/zsh
      _DOCK_COMPLETE=zsh_source #{bin}/dock
    EOS

    chmod 0755, buildpath/"generate-bash-completion.sh"
    chmod 0755, buildpath/"generate-zsh-completion.sh"

    generate_completions_from_executable(buildpath/"generate-bash-completion.sh",
                                         shells: [:bash], base_name: "dock")
    generate_completions_from_executable(buildpath/"generate-zsh-completion.sh",
                                         shells: [:zsh], base_name: "dock")
  end

  test do
    # Test that the command is available and shows version
    assert_match "version", shell_output("#{bin}/dock --version")

    # Test that the command shows help
    assert_match "Manage macOS Dock", shell_output("#{bin}/dock --help")

    # Test validate command with a simple config
    (testpath/"test-config.yml").write <<~EOS
      apps:
        - Safari
      settings:
        autohide: false
    EOS

    assert_match "valid", shell_output("#{bin}/dock validate --file #{testpath}/test-config.yml")

    # Test that shell completions were installed
    assert_path_exists bash_completion/"dock"
    assert_path_exists zsh_completion/"_dock"

    # Test that completions contain expected content
    assert_match "dock", (bash_completion/"dock").read
    assert_match "dock", (zsh_completion/"_dock").read
  end
end

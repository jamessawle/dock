name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
      
      - name: Install dependencies
        run: uv sync
      
      - name: Run linting
        run: make lint
      
      - name: Run type checking
        run: make type-check
      
      - name: Run tests
        run: make test
      
      - name: Generate shell completions
        run: make completions
      
      - name: Build distribution packages
        run: uv build
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
          draft: false
          prerelease: false
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Update Homebrew formula
        run: ./scripts/update-formula.sh --release
      
      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: jamessawle/homebrew-tap
          token: ${{ secrets.TAP_PUSH_TOKEN }}
          path: homebrew-tap
      
      - name: Update formula in tap
        run: |
          mkdir -p homebrew-tap/Formula
          cp Formula/dock.rb homebrew-tap/Formula/dock.rb
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="update-dock-${{ steps.version.outputs.VERSION }}"
          git checkout -b "$BRANCH_NAME"
          
          git add Formula/dock.rb
          if ! git diff --staged --quiet; then
            git commit -m "dock: update to version ${{ steps.version.outputs.VERSION }}"
            git push origin "$BRANCH_NAME"
          fi
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.TAP_PUSH_TOKEN }}
        run: |
          cd homebrew-tap
          gh pr create \
            --repo jamessawle/homebrew-tap \
            --base main \
            --head update-dock-${{ steps.version.outputs.VERSION }} \
            --title "dock: update to version ${{ steps.version.outputs.VERSION }}" \
            --body "Automated update of dock formula to version ${{ steps.version.outputs.VERSION }}

          Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.VERSION }}"
